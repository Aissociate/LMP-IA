/*
  # Fix critical security vulnerability in is_admin() function

  ## Problem
  - The is_admin() function checked if company or full_name contained "admin"
  - Any user could gain admin access by setting their company to "Admin Corp"
  - This is a privilege escalation vulnerability

  ## Fix
  - Use the actual `is_admin` boolean column on user_profiles
  - This column can only be set by admins via service_role, not by users

  ## Impact
  - All RLS policies using is_admin() will now correctly check the is_admin column
  - Policies already using inline `user_profiles.is_admin = true` are unaffected
*/

CREATE OR REPLACE FUNCTION is_admin()
RETURNS boolean
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, pg_temp
AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1
    FROM user_profiles
    WHERE user_id = auth.uid()
    AND is_admin = true
  );
END;
$$;
